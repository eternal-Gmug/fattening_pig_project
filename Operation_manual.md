# 育猪行为标注工具运维手册

## 1. 系统概述

### 1.1 系统架构

育猪行为标注工具是一个基于Python开发的专业标注系统，采用模块化架构设计，主要包含以下核心组件：

- **标注工具界面层**：基于PySide6构建的图形用户界面，提供友好的交互体验
- **模型推理层**：通过ONNX Runtime实现的深度学习模型推理功能
- **数据处理层**：处理视频帧读取、图像预处理和标注数据管理
- **数据持久化层**：负责标注结果的保存和导出

系统支持两种主要标注模式：
- **方框标注工具 (BoxAnnotationTool)**：用于快速标记猪只位置和姿态
- **分割标注工具 (SegmentationAnnotationTool)**：用于精确的轮廓分割标注（可选功能）

### 1.2 技术栈

- **编程语言**：Python 3.7+
- **GUI框架**：PySide6
- **图像处理**：OpenCV (opencv-python)
- **数值计算**：NumPy
- **深度学习推理**：ONNX Runtime
- **模型**：YOLOv8m系列模型
- **打包工具**：PyInstaller

### 1.3 系统流程

1. **初始化阶段**：加载配置、初始化界面组件
2. **文件加载阶段**：读取视频/图像文件，处理为帧数据
3. **标注阶段**：
   - 自动标注：调用ONNX模型进行猪只检测和姿态识别
   - 手动标注：用户交互调整标注框位置、大小和类别
4. **数据保存阶段**：将标注结果导出为JSON和TXT格式

## 2. 系统部署与配置

### 2.1 环境要求

- **操作系统**：Windows 10/11、Linux或macOS
- **CPU**：至少4核处理器
- **内存**：推荐8GB以上
- **GPU**（可选）：支持CUDA的NVIDIA显卡（用于加速模型推理）
- **存储空间**：至少1GB可用空间

### 2.2 安装与部署

#### 2.2.1 直接运行可执行文件（推荐）

1. 从`dist`目录获取`annotation_tool.exe`
2. 确保`model`目录与可执行文件在同一目录下，包含所需的模型文件
3. 直接运行可执行文件

#### 2.2.2 源码运行

1. 克隆或下载项目源码
2. 安装依赖：
   ```bash
   pip install -r requirements.txt
   ```
3. 运行主程序：
   ```bash
   python annotation_tool.py
   ```

### 2.3 配置文件说明

系统主要配置参数存储在程序内部的`config`字典中，包含以下关键配置：

| 配置项 | 说明 | 默认值 |
|-------|------|-------|
| default_input_path | 默认输入文件路径 | ./input_atlas |
| output_txt_path | TXT格式输出路径 | ./output |
| output_video_path | 视频输出路径 | ./processed_videos |
| model_path | 模型文件路径 | ./model/pig_gesture_best.onnx |
| classes_path | 类别文件路径 | ./model/classes.txt |

## 3. 日常维护

### 3.1 模型维护

- 定期检查`model`目录中的模型文件是否完整
- 如需更新模型，直接替换相应的ONNX文件
- 如需添加新的猪只姿态类别，修改`model/classes.txt`文件

### 3.2 数据管理

- 定期清理`output`目录中的过期数据
- 重要标注结果建议备份到其他存储位置
- 大文件处理前确保有足够的磁盘空间

### 3.3 性能监控

- 监控内存使用情况，处理大型视频时尤为重要
- 对于CUDA加速的系统，监控GPU使用率和温度
- 记录程序响应时间异常的情况

## 4. 故障排查指南

### 4.1 启动故障

#### 4.1.1 可执行文件无法启动

**可能原因**：
- 缺少必要的DLL文件
- 模型文件不存在或路径错误
- 系统权限不足

**排查步骤**：
1. 检查`model`目录是否存在且包含所需的模型文件
2. 确保程序有足够的权限访问所需文件
3. 尝试以管理员身份运行程序
4. 如果问题持续，尝试从源码运行并查看错误信息

#### 4.1.2 源码运行报错

**可能原因**：
- Python版本不兼容
- 依赖库未正确安装
- 路径配置错误

**排查步骤**：
1. 确认Python版本为3.7或更高
2. 重新安装依赖：`pip install -r requirements.txt`
3. 检查错误信息中提到的具体模块缺失
4. 确保模型文件路径正确

### 4.2 文件加载故障

#### 4.2.1 视频文件无法加载

**错误信息**："无法打开视频文件" 或 "Could not find decoder for codec_id=61"

**排查步骤**：
1. 检查视频文件格式是否受支持（mp4、avi、mov等）
2. 确认视频文件未损坏，尝试用其他播放器打开
3. 检查文件路径是否包含中文或特殊字符
4. 检查磁盘空间是否充足
5. **FFmpeg编解码器问题**（如出现codec_id=61错误）：
   - 确认系统已安装完整版本的FFmpeg
   - 重新安装OpenCV，确保它与FFmpeg正确链接
   - 对于Windows系统，可以尝试安装K-Lite Codec Pack等编解码器包
   - 或者从源代码构建OpenCV时明确启用FFmpeg支持

#### 4.2.2 图像文件无法加载

**错误信息**："无法打开图片文件"

**排查步骤**：
1. 确认图像格式正确（jpg、jpeg、png、bmp等）
2. 检查图像文件是否损坏
3. 检查文件路径是否过长或包含特殊字符

#### 4.2.3 文件夹加载失败

**错误信息**："加载文件夹时出错"

**排查步骤**：
1. 确认文件夹路径正确且包含图像文件
2. 检查文件夹访问权限
3. 检查文件夹中是否有非图像文件干扰

### 4.3 模型推理故障

#### 4.3.1 模型加载失败

**可能原因**：
- ONNX模型文件不存在或损坏
- ONNX Runtime版本不兼容
- CUDA相关问题（如果使用GPU）

**排查步骤**：
1. 确认`model/pig_gesture_best.onnx`文件存在且完整
2. 检查`onnxruntime`版本是否满足要求（>=1.9.0）
3. 如果使用GPU加速，确认CUDA环境配置正确
4. 尝试更换为CPU模式运行（修改`providers`参数）

#### 4.3.2 推理结果异常

**现象**：检测不到猪只或误检率高

**排查步骤**：
1. 检查图像/视频质量，确保光线充足、猪只清晰可见
2. 确认输入图像与模型训练数据的格式一致
3. 尝试调整置信度阈值（默认为0.3）
4. 考虑更新模型文件

### 4.4 标注功能故障

#### 4.4.1 标注框无法创建或编辑

**可能原因**：
- 界面状态异常
- 鼠标交互模式错误
- 程序资源不足

**排查步骤**：
1. 确认处于正确的标注模式
2. 检查是否已加载视频/图像
3. 尝试重启程序
4. 检查系统内存使用情况

#### 4.4.2 删除标注框功能异常

**错误信息**：删除按钮点击后无反应

**排查步骤**：
1. 确认已正确选中要删除的标注框
2. 检查标注框是否与当前帧关联
3. 查看程序是否抛出异常信息

### 4.5 帧导航故障

#### 4.5.1 帧跳转无响应

**可能原因**：
- 视频尚未完全加载
- 线程锁问题
- 帧索引越界

**排查步骤**：
1. 等待视频加载完成（特别是大文件）
2. 检查帧索引是否在有效范围内
3. 避免连续快速点击导航按钮（程序有防重复点击机制）

#### 4.5.2 固定间隔帧跳转错误

**错误信息**："k值必须为正整数" 或 "请输入有效的k值"

**排查步骤**：
1. 确认输入框中填写了有效的正整数
2. 检查跳转间隔是否超过视频总帧数
3. 等待视频加载到足够的帧数

### 4.6 保存与导出故障

#### 4.6.1 保存项目失败

**错误信息**："保存项目时出错"

**排查步骤**：
1. 检查输出目录是否存在且有写入权限
2. 确认磁盘空间充足
3. 检查文件路径是否包含特殊字符

#### 4.6.2 导出视频失败

**错误信息**："导出视频时出错"

**排查步骤**：
1. 确认视频编码格式受支持
2. 检查输出路径权限
3. 确保有足够的磁盘空间
4. 对于大型视频，尝试降低输出视频的分辨率或质量

## 5. 常见问题解答

### 5.1 性能优化相关

**Q: 程序运行缓慢，如何优化？**
A: 
- 关闭其他占用系统资源的程序
- 使用GPU加速（确保安装了兼容的CUDA版本）
- 对于长视频，考虑降低视频分辨率或采样率
- 增加视频帧跳跃间隔，减少处理的帧数

**Q: 内存占用过高怎么办？**
A: 
- 处理大型视频时，考虑分割为多个短片段
- 增加帧跳跃间隔，减少同时加载的帧数
- 及时关闭不需要的功能窗口

### 5.2 功能使用相关

**Q: 如何添加新的猪只姿态类别？**
A: 
1. 编辑`model/classes.txt`文件
2. 添加新的类别名称（每行一个）
3. 确保使用新的训练模型来识别新增的类别

**Q: 如何调整自动标注的置信度阈值？**
A: 
在`onnxdealA.py`文件中修改`main`函数中的阈值判断条件（默认为0.3）。

**Q: 如何自定义标注框的颜色？**
A: 
在程序界面中，通过颜色选择器工具可以更改标注框的默认颜色。

### 5.3 部署相关

**Q: 如何在没有Python环境的电脑上运行？**
A: 
使用已打包的可执行文件`annotation_tool.exe`，确保包含`model`目录及其文件。

**Q: 如何创建新的可执行文件？**
A: 
```bash
pip install pyinstaller
pyinstaller annotation_tool.spec
```

**Q: 程序在不同操作系统间是否兼容？**
A: 
源代码可在Windows、Linux和macOS上运行，但需要为每个平台单独打包可执行文件。

## 6. 日志与监控

### 6.1 错误日志

程序的错误信息会通过以下方式记录：
- 通过`QMessageBox`向用户显示错误提示
- 在控制台输出详细的异常信息

在源码运行模式下，可以通过捕获控制台输出来获取完整的错误日志。

### 6.2 性能监控

建议监控以下系统资源使用情况：
- CPU使用率
- 内存占用
- GPU使用率（如果使用GPU加速）
- 磁盘I/O

对于长时间运行的标注任务，定期检查系统资源使用情况，避免资源耗尽。

## 7. 紧急响应流程

### 7.1 程序崩溃处理

1. 记录崩溃前的操作步骤
2. 检查程序是否生成了错误日志
3. 尝试重启程序
4. 如果问题持续，尝试从源码运行并捕获详细错误信息
5. 根据错误信息参考本文档的故障排查部分

### 7.2 数据恢复

如果在保存前程序崩溃，部分临时标注数据可能会丢失。建议：
1. 定期保存项目，不要等到全部标注完成后再保存
2. 对于重要项目，考虑手动备份中间结果
3. 程序具有基本的会话恢复能力，可以尝试重启程序加载最近的工作状态

## 8. 附录

### 8.1 模型文件说明

| 模型文件 | 说明 |
|---------|------|
| yolov8m_gray.onnx | 针对灰度图像优化的YOLOv8m目标检测模型 |
| pig_gesture_best.onnx | 猪只姿态识别的最佳模型 |
| classes.txt | 定义了模型可识别的猪只姿态类别 |

### 8.2 文件格式说明

#### 8.2.1 输出TXT格式

每行一个标注，格式为：`类别ID,中心点x,中心点y,宽度,高度，体重数值（如果有）`

#### 8.2.2 输出JSON格式

每个JSON文件包含单个帧的所有标注信息，格式如下：
```json
[
    {
       "class_id": "类别ID",
       "x_center": "中心点x",
       "y_center": "中心点y",
       "width": "宽度",
       "height": "高度",
       "text": "体重数值（如果有）"
    },
    {
       "class_id": "类别ID",
       "x_center": "中心点x",
       "y_center": "中心点y",
       "width": "宽度",
       "height": "高度",
       "text": "体重数值（如果有）"
    }
]
```

### 8.3 系统限制

- 支持的视频格式：mp4、avi、mov
- 支持的图像格式：jpg、jpeg、png、bmp
- 单个项目推荐处理的最大视频长度：30分钟（超过可能导致性能问题）
- 每帧最大支持的标注框数量：根据系统性能而定，建议不超过50个

---

本运维手册会根据系统更新和用户反馈定期更新。如有未解决的问题，请联系开发团队获取技术支持。